<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Leaflet Map Example</title>
  <!-- Include Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />

  <!-- Include Leaflet JavaScript -->
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-routing-machine/3.2.12/leaflet-routing-machine.min.js"></script>
  
  <!-- Include Leaflet Control Geocoder plugin -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
  <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>

  <!-- Include Bootstrap CSS -->
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css" integrity="sha384-9aIt2nRpC12Uk9gS9baDl411NQApFmC26EwAOH8WgZl5MYYxFfc+NcPb1dKGj7Sk" crossorigin="anonymous">

  <!-- Include Bootstrap JavaScript -->
  <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.1/dist/umd/popper.min.js" integrity="sha384-S2n8T1uK9u6I7mNQoSQ2L1j6lMPtI6+ZG4/pmaPcZ17iEFV3f52+qX6V4onKvAzo" crossorigin="anonymous"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js" integrity="sha384-OgVRvuATP1z7JjHLkuOU7Xw704+h835Lr+6QL9UvYjZE3Ipu6Tp75j7Bh/kR0JKI" crossorigin="anonymous"></script>

  <style>
    #map {
      position: fixed;
      top: 0;
      bottom: 0;
      left: 0;
      right: 0;
    }
    .my-location-btn {
      position: fixed;
      bottom: 10px;
      right: 10px;
      z-index: 1000;
      background-color: #fff;
      border: 1px solid #ccc;
      padding: 5px 10px;
      cursor: pointer;
    }
    .direction-btn {
      position: fixed;
      bottom: 70px;
      left: 10px;
      z-index: 1000;
      background-color: #fff;
      border: 1px solid #ccc;
      padding: 5px 10px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <!-- Create a div element with the id "map" to hold the map -->
  <div id="map"></div>

  <div class="my-location-btn" onclick="locateMe()">My Location</div>
  <div class="direction-btn" data-toggle="modal" data-target="#directionModal">Direction</div>

  <!-- Direction Modal -->
  <div class="modal fade" id="directionModal" tabindex="-1" role="dialog" aria-labelledby="directionModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="directionModalLabel">Enter Source and Destination</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <form id="directionForm">
            <div class="form-group">
              <label for="sourceInput">Source:</label>
              <input type="text" class="form-control" id="sourceInput" required>
            </div>
            <div class="form-group">
              <label for="destinationInput">Destination:</label>
              <input type="text" class="form-control" id="destinationInput" required>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-primary" onclick="setSourceAndDestination()">Go</button>
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    var map = L.map('map').setView([51.505, -0.09], 13);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors',
      maxZoom: 18,
    }).addTo(map);

    var myLocationMarker = null; // Track my location marker
    var sourceMarker = null; // Track source marker
    var destinationMarker = null; // Track destination marker

    // Custom icons
    var myLocationIcon = L.icon({
      iconUrl: 'path/to/my-location-icon.png',
      iconSize: [32, 32],
      iconAnchor: [16, 32],
      popupAnchor: [0, -32],
    });

    var sourceIcon = L.icon({
      iconUrl: 'path/to/source-icon.png',
      iconSize: [32, 32],
      iconAnchor: [16, 32],
      popupAnchor: [0, -32],
    });

    var destinationIcon = L.icon({
      iconUrl: 'path/to/destination-icon.png',
      iconSize: [32, 32],
      iconAnchor: [16, 32],
      popupAnchor: [0, -32],
    });

    // Add routing control
    var routingControl;

    function updateRoute(source, destination) {
      if (routingControl) {
        map.removeControl(routingControl);
      }
      routingControl = L.Routing.control({
        waypoints: [
          source,
          destination
        ],
        routeWhileDragging: true,
        show: false // Do not display the route immediately
      });

      routingControl.on('routesfound', function(e) {
        if (e.routes.length === 0) {
          map.removeLayer(destinationMarker);
          destinationMarker = null;
        }
      });

      routingControl.addTo(map);
      routingControl.route();
    }

    // Function to get user's location and center map
    function locateMe() {
      map.locate({ setView: true, maxZoom: 16 });
    }

    // Event listener for when user's location is found
    map.on('locationfound', function(e) {
      if (!myLocationMarker) {
        myLocationMarker = L.marker(e.latlng, { icon: myLocationIcon, draggable: false }).addTo(map);
      } else {
        myLocationMarker.setLatLng(e.latlng);
      }
    });

    // Event listener for when user's location is not found
    map.on('locationerror', function(e) {
      alert("Location access denied.");
    });

    // Function to handle setting source and destination from the modal
    function setSourceAndDestination() {
      var sourceInput = document.getElementById('sourceInput').value;
      var destinationInput = document.getElementById('destinationInput').value;

      if (sourceInput && destinationInput) {
        // Geocode source and destination to get coordinates
        geocodeAndAddMarker(sourceInput, function(sourceLatLng) {
          if (!sourceMarker) {
            sourceMarker = L.marker(sourceLatLng, { icon: sourceIcon, draggable: false, opacity: 0 }).addTo(map);
          } else {
            sourceMarker.setLatLng(sourceLatLng);
          }

          geocodeAndAddMarker(destinationInput, function(destinationLatLng) {
            if (!destinationMarker) {
              destinationMarker = L.marker(destinationLatLng, { icon: destinationIcon, draggable: false, opacity: 0 }).addTo(map);
            } else {
              destinationMarker.setLatLng(destinationLatLng);
            }

            // Update the route
            updateRoute(sourceLatLng, destinationLatLng);

            // Close the modal
            $('#directionModal').modal('hide');

            // Clear input fields
            document.getElementById('sourceInput').value = '';
            document.getElementById('destinationInput').value = '';
          });
        });
      } else {
        alert('Please enter both source and destination.');
      }
    }

    // Function to geocode a location and add a marker to the map
    function geocodeAndAddMarker(location, callback) {
      var geocoder = L.Control.Geocoder.nominatim();
      geocoder.geocode(location, function(results) {
        if (results && results.length > 0) {
          var latlng = L.latLng(results[0].center.lat, results[0].center.lng);
          callback(latlng);
        } else {
          alert('Location not found: ' + location);
        }
      });
    }

    // Initialize Leaflet Control Geocoder plugin
    var geocoder = L.Control.Geocoder.nominatim();
    var control = L.Control.geocoder({
      geocoder: geocoder
    }).on('select', function(e) {
      // When a location is selected, update source or destination input fields
      var inputId = document.activeElement.id;
      if (inputId === 'sourceInput' || inputId === 'destinationInput') {
        document.getElementById(inputId).value = e.name;
      }
    });
    control.addTo(map);
  </script>
</body>
</html>
